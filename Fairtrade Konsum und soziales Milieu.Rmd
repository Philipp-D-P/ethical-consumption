---
title: "Fairtrade Konsum und soziales Milieu"
author: "Philipp Penner - Matr.-Nr.: 4322128"
date: "30.09.2020"
output: html_document
---
#### Datensatz: Umweltbewusstsein in Deutschland 2016 (Welle 1) - Version 1.0.0 (12.04.2017)
#### Datenzugang: https://doi.org/10.4232/1.12764 (Gesis-Archiv - SPSS Datensatz - SAV Format)
#### R Version 4.0.2 (22.06.2020) - RStudio Version 1.3.1056
<br> 

#### Workspace leeren
```{r}
rm(list = ls())
```


```{r setup, include=F}
## Pakete müssen vorher einmal im setup-chunk geladen werden
knitr::opts_chunk$set(echo = TRUE)
Pakete <- c("tidyverse",     ## 1.3.0
            "naniar",        ## 0.5.0
            "haven",         ## 2.2.0
            "survey",        ## 3.37
            "car",           ## 3.0-6
            "gmodels",       ## 2.18.1
            "psych",         ## 1.9.12.31
            "mfx",           ## 1.2-2
            "epiDisplay",    ## 3.5.0.1
            "effects",       ## 4.1-4
            "DescTools",     ## 0.99.37
            "margins"        ## 0.3.23
            )

lapply(Pakete, require, character.only = T)
```

#### Pakete laden
```{r eval=F, message=FALSE}
Pakete <- c("tidyverse",     ## 1.3.0
            "naniar",        ## 0.5.0
            "haven",         ## 2.2.0
            "survey",        ## 3.37
            "car",           ## 3.0-6
            "gmodels",       ## 2.18.1
            "psych",         ## 1.9.12.31
            "mfx",           ## 1.2-2
            "epiDisplay",    ## 3.5.0.1
            "effects",       ## 4.1-4
            "DescTools",     ## 0.99.37
            "margins"        ## 0.3.23
            )

lapply(Pakete, require, character.only = T)
```


### Datenimport und -aufbereitung (Vorbereitung der Analyse)

#### Datensatz einlesen
```{r}
Daten <- read_sav("Daten/Umweltbewusstsein_DE_2016_Welle1_v1-0-0.sav")
```

#### Variablenset erstellen 
```{r}
UB <- Daten %>%
  dplyr::select(f624_3, ## Kaufe möglichst nur Produkte, die unter fairen Arbeitsbedingungen hergestellt wurden.
                f821,   ## Geschlecht (m = 1 / w = 2) 
                f8210,  ## Monatliche Nettoeinkommen eines Haushaltes insgesamt (in 11 Einkommensgruppen).
                nf822,  ## Alter der Befragten in Jahren +Alterskategorien ebenfalls vorhanden).
                f823,   ## Bildungsabschluss (höchster Schulabschluss oder Hochschulabschluss). 
                QCL_1,  ## Soziale Milieus (sechs gesellschaftliche Segmente, 17 Items zur Identifikation)
                weight  ## Gewichtungsvariable (Gewichtung nach Region, Geschlecht, Alter und Bildung)
                )
```

#### Irrelevante Daten zur Übersichtlichkeit entfernen
```{r}
rm(Daten)
```

#### Fehlende Angaben bzw. nicht brauchbare Werte als "NA" definieren
```{r}
UB <- UB %>%
  mutate(f624_3 = na_if(f624_3, 5), ## "weiß nicht"
         f8210  = na_if(f8210, 12), ## "keine Angabe"
         f823   = na_if(f823, 1),   ## "noch Schüler/Schülerin"
         f823   = na_if(f823, 7),   ## "anderen Schulabschluss"
         f823   = na_if(f823, 8)    ## "keine Angabe"
         )
```

#### Variablen für Analyse umkodieren / dichotomisieren
<br>

#### Zielvariable Kaufwahrscheinlichkeit dichotomisieren als neue Variable "kauf"
#### Umkodieren der Kategorien 1 und 2 zu 1 = Ja / Kategorien 3 und 4 zu 0 = Nein
```{r}
UB <- UB %>%
  mutate(kauf = car::recode(UB$f624_3,
                            "1:2 = 1; 3:4 = 0; else = NA", as.factor = T))
```

#### Geschlecht von m = 1 / w = 2 zu m = 0 / w = 1
#### Neue Variable "weiblich" (weiblich = 1)
```{r}
UB$weiblich <- dummy.code(UB$f821, group = 2)
```

#### Milieu als Faktorvariable definieren und damit automatisch eine Dummy-Variable erzeugen
#### Neue Variable "milieu" (Milieu 1 automatisch als Referenzkategorie gesetzt)
#### Bedeutet: Das erste Milieu geht mit 0 und die anderen Kategorien jeweils mit 1 in die Berechnung ein
```{r}
UB <- UB %>%
  mutate(milieu = car::recode(UB$QCL_1,
                            "1 = 1;
                             2 = 2;
                             3 = 3;
                             4 = 4; 
                             5 = 5;
                             6 = 6", 
                             as.factor = T))
```

#### Verteilung der Milieus auf eine Nachkommastelle gerundet
```{r}
round(prop.table(table(UB$milieu))*100, digits = 1)
```

#### Wie ist die Variable "milieu" als Faktor genau aufgebaut. Wichtig für spätere Modelinterpretation
```{r}
contrasts(UB$milieu)
```

#### Referenzkategorie der Variable milieu auf 4 ändern (Vorbereitung für logistische Regression)
```{r}
UB$milieu <- relevel (UB$milieu, ref = "4")
```

#### Struktur der Variable nach der Änderung der Referenzkategorie
#### Viertes Milieu (Prekäre) als Referenz gesetzt und Wert 0 zugewiesen
```{r}
contrasts(UB$milieu)
```

#### Bildung als Faktorvariable definieren und damit automatisch eine Dummy-Variable erzeugen
#### Neue Variable "bildung" ("ohne Abschluss" automatisch als Referenzkategorie gesetzt)
```{r}
UB$bildung <- factor(UB$f823)
```

#### Altersvariable als "alter" hinzufügen für Übersichtlichkeit
```{r}
UB$alter <- UB$nf822
```

#### Einkommensvariable als "einkommen" hinzufügen für Übersichtlichkeit
```{r}
UB$einkommen <- UB$f8210
```

#### Analyse fehlender Werte 

```{r}
summary(UB)
```

#### Visualisierung fehlender Werte
```{r, fig.width=10,fig.height=6}
Variablen <-data.frame(UB$weiblich, UB$bildung, UB$einkommen, UB$alter, UB$milieu, UB$kauf)
gg_miss_var(Variablen)
```

### Anwendungsvoraussetzungen der binären logitischen Regression prüfen

#### 1. Keine extreme Ungleichverteilung der abhängigen Variable
```{r}
prop.table(table(UB$kauf))*100
```

```{r include=FALSE}
## Regression vor Berechnung der vif-Werte, damit Berechnung möglich wird
m6.w <- glm(kauf ~ weiblich + bildung + einkommen + alter + milieu,
            family = binomial,
            data = UB,
            weights = weight)
summary(m6.w)
```

#### 2. Ausreichend Fälle in den Kategorien der Prädiktorvariable in Verbindung mit Zielvariable
```{r}
CrossTable(UB$milieu, UB$kauf, prop.r=T, prop.c=F, prop.t=F, prop.chisq=F, digits = 2) 
```

#### 3. Geringe Multikollinearität (Überprüft für Gesamtmodell)
#### variance inflation factor (VIF) (sollten nicht über 10 liegen)
```{r}
vif(m6.w)
```




### Binär logistisches Regressionsmodell

#### Abhängige Variable: Kauf von Fairtrade Ja (1) / Nein (0)
#### Unabhängige Variablen: Geschlecht, Bildung, Einkommen, Alter, Milieu
#### Ausschluss von Fällen mit fehlenden Werten ("na.action=na.omit" als Standard gesetzt)
#### Modelle (jeweils einzeln und am Ende in einem Modell zusammen)
#### Es kommt jeweils die Fehlermeldung "non-integer #successes in a binomial glm!"
#### Das ist der Gewichtung geschuldet, da keine ganzzahligen Werte mehr vorliegen
#### Die Fehlermeldung wird im folgenden Output daher ausgeblendet 
<br>

#### Nullmodell (ungewichtet)
```{r}
m.null <- glm(kauf ~ 1,
              family = binomial,
              data = UB)
summary(m.null)
```

#### Geschlecht (gewichtet)
```{r warning=FALSE}
m1.w <- glm(kauf ~ weiblich,
            family = binomial,
            data = UB,
            weights = weight)
summary(m1.w)
```

#### Bildung (gewichtet)
```{r warning=FALSE}
m2.w <- glm(kauf ~ bildung,
            family = binomial,
            data = UB,
            weights = weight)
summary(m2.w)
```

#### Einkommen (gewichtet)
```{r warning=FALSE}
m3.w <- glm(kauf ~ einkommen,
            family = binomial,
            data = UB,
            weights = weight)
summary(m3.w)
```

#### Alter (gewichtet)
```{r warning=FALSE}
m4.w <- glm(kauf ~ alter,
            family = binomial,
            data = UB,
            weights = weight)
summary(m4.w)
```

#### Milieu (gewichtet)
```{r warning=FALSE}
m5.w <- glm(kauf ~ milieu,
            family = binomial,
            data = UB,
            weights = weight)
summary(m5.w)
```

#### Gesamtmodell (gewichtet) - Soziodemografie als Kontrollvariablen
```{r warning=FALSE}
m6.w <- glm(kauf ~ weiblich + bildung + einkommen + alter + milieu,
            family = binomial,
            data = UB,
            weights = weight)
summary(m6.w)
```

#### Modellvergleich und Modellgüte
#### Log-Likelihood
```{r}
logLik(m.null)
logLik(m5.w) 
logLik(m6.w)
```

#### Likelihood-Ratio-Test
```{r}
lrtest(m.null, m5.w)
```

#### AIC - Akaike Information Criterion
```{r warning=FALSE}
AIC(m.null, m5.w, m6.w)
```


#### BIC - Bayesian Information Criterion 
```{r warning=FALSE}
BIC(m.null, m5.w, m6.w)
```

#### Pseudo R2 (McKelvey & Zavoina)
#### Direkt in Prozent und auf eine Nachkommastelle gerundet
```{r echo=TRUE, warning=FALSE}
round((PseudoR2(m1.w, "McKelveyZavoina")*100), digits = 1)   ## Geschlecht
round((PseudoR2(m2.w, "McKelveyZavoina")*100), digits = 1)   ## Bildung
round((PseudoR2(m3.w, "McKelveyZavoina")*100), digits = 2)   ## Einkommen
round((PseudoR2(m4.w, "McKelveyZavoina")*100), digits = 1)   ## Alter
round((PseudoR2(m5.w, "McKelveyZavoina")*100), digits = 1)   ## Milieu
```

#### Gesamtmodell - R2 (McKelvey & Zavoina)

```{r warning=FALSE}
round((PseudoR2(m6.w, "McKelveyZavoina")*100), digits = 1) ## Gesamtmodell
```

#### Anteil der erklärten Varianz durch Milieu in Gesamtheit der erklärten Varianz
```{r}
round(11.9/21.2*100, digits = 1)
```

#### Erweiterte Analyse der Modelle

#### Odds Ratio
```{r warning=FALSE}
logistic.display(m5.w)
logistic.display(m6.w)
```

#### AME (Average Marginal Effects)
```{r}
m5.w.marginal <- margins(m5.w)
summary(m5.w.marginal)

m6.w.marginal <- margins(m6.w) 
summary(m6.w.marginal)
```

#### Visualisierung der AME
```{r, fig.width=10,fig.height=6}
m5.w.marginal.sum <- summary(m5.w.marginal)

ggplot(data = m5.w.marginal.sum) +
  geom_point(aes(factor, AME)) +
  geom_errorbar(aes(x = factor, ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45))
```

```{r, fig.width=10,fig.height=6}
m6.w.marginal.sum <- summary(m6.w.marginal)

ggplot(data = m6.w.marginal.sum) +
  geom_point(aes(factor, AME)) +
  geom_errorbar(aes(x = factor, ymin = lower, ymax = upper)) +
  geom_hline(yintercept = 0) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45))
```



